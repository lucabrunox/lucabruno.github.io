<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Nix pill 2: install on your running system | Luca Bruno blog</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="Welcome to the second Nix pill. In the first pill we briefly described Nix.
Now we&rsquo;ll install Nix on our running system and understand what changed in our system after the installation.
Nix installation is as easy as installing any other package. It will not revolutionize our system, it will stay in its own place out of our way.
Download You can grab the last stable tarball (nix 1.7 during this writing) or the package for your distro here: http://hydra.">
    <meta name="generator" content="Hugo 0.125.2">
    
    
    
    
      <meta name="robots" content="noindex, nofollow">
    
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >



    

    
      

    

    

    
      <link rel="canonical" href="https://lucabrun.github.io/2014/07/nix-pill-2-install-on-your-running.html">
    

    <meta property="og:url" content="https://lucabrun.github.io/2014/07/nix-pill-2-install-on-your-running.html">
  <meta property="og:site_name" content="Luca Bruno blog">
  <meta property="og:title" content="Nix pill 2: install on your running system">
  <meta property="og:description" content="Welcome to the second Nix pill. In the first pill we briefly described Nix.
Now we&amp;rsquo;ll install Nix on our running system and understand what changed in our system after the installation.
Nix installation is as easy as installing any other package. It will not revolutionize our system, it will stay in its own place out of our way.
Download You can grab the last stable tarball (nix 1.7 during this writing) or the package for your distro here: http://hydra.">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2014-07-24T08:38:00-07:00">
    <meta property="article:modified_time" content="2014-07-24T08:38:00-07:00">
    <meta property="article:tag" content="Nixpkgs">
    <meta property="article:tag" content="Nix">
    <meta property="article:tag" content="Nixpills">
    <meta property="article:tag" content="Nixos">

  <meta itemprop="name" content="Nix pill 2: install on your running system">
  <meta itemprop="description" content="Welcome to the second Nix pill. In the first pill we briefly described Nix.
Now we&rsquo;ll install Nix on our running system and understand what changed in our system after the installation.
Nix installation is as easy as installing any other package. It will not revolutionize our system, it will stay in its own place out of our way.
Download You can grab the last stable tarball (nix 1.7 during this writing) or the package for your distro here: http://hydra.">
  <meta itemprop="datePublished" content="2014-07-24T08:38:00-07:00">
  <meta itemprop="dateModified" content="2014-07-24T08:38:00-07:00">
  <meta itemprop="wordCount" content="1231">
  <meta itemprop="keywords" content="Nixpkgs,Nix,Nixpills,Nixos"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Nix pill 2: install on your running system">
<meta name="twitter:description" content="Welcome to the second Nix pill. In the first pill we briefly described Nix.
Now we&rsquo;ll install Nix on our running system and understand what changed in our system after the installation.
Nix installation is as easy as installing any other package. It will not revolutionize our system, it will stay in its own place out of our way.
Download You can grab the last stable tarball (nix 1.7 during this writing) or the package for your distro here: http://hydra.">

	
  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        Luca Bruno blog
      
    </a>
    <div class="flex-l items-center">
      

      
      
<div class="ananke-socials">
  
</div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside>
      










  <div id="sharing" class="mt3 ananke-socials">
    
  </div>


      <h1 class="f1 athelas mt3 mb1">Nix pill 2: install on your running system</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2014-07-24T08:38:00-07:00">July 24, 2014</time>
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>Welcome to the second Nix pill. In <a href="http://lethalman.blogspot.it/2014/07/nix-pill-1-why-you-should-give-it-try.html">the first pill</a> we briefly described Nix.<br>
Now we&rsquo;ll install Nix on our running system and understand what changed in our system after the installation.</p>
<p><a href="http://nixos.org/nix/manual/#chap-installation">Nix installation</a> is as easy as installing any other package. It will not revolutionize our system, it will stay in its own place out of our way.</p>
<h3 id="download">Download</h3>
<p>You can grab the last stable tarball (nix 1.7 during this writing) or the package for your distro here: <a href="http://hydra.nixos.org/release/nix/nix-1.7">http://hydra.nixos.org/release/nix/nix-1.7</a> .<br>
At the time you are reading, there may be nix 1.8. You can see a list of releases here: <a href="http://hydra.nixos.org/project/nix#tabs-releases">http://hydra.nixos.org/project/nix#tabs-releases</a> .</p>
<p>I prefer using the precompiled binaries, because it&rsquo;s a nice self-contained environment, just works and it&rsquo;s a little less invasive (in that it does not install anything under /etc or /usr). So in this series I will use the nix bootstrap distribution.<br>
In the download page above you can find binaries for linux i686, x86_64 and darwin.</p>
<p>Note: if you are using a rolling distribution however, I suggest not to install the package (for example on Debian sid) because you will experience broken perl dependencies when running nix tools.</p>
<h3 id="installation"><strong>Installation</strong></h3>
<p>To ensure we don&rsquo;t mess with the system, you could create a custom user to let him own the Nix store, let&rsquo;s call it &ldquo;nix&rdquo;.</p>
<p>As root:</p>
<pre tabindex="0"><code>\# adduser nix
# mkdir -m 0755 /nix &amp;&amp; chown nix /nix
</code></pre><p>From now on, all the operations we do on the shell are done from this nix user:</p>
<pre tabindex="0"><code>\# su - nix
$ tar -xf nix-1.7-x86\_64-linux.tar.bz2
$ cd nix-1.7-x86\_64-linux
$ ./install
</code></pre><p>My pills are not a simple tutorial, there&rsquo;s are several <a href="http://nixos.org/nix/manual/#chap-package-management">articles</a> <a href="https://www.domenkozar.com/2014/01/02/getting-started-with-nix-package-manager/">out</a> <a href="https://ocharles.org.uk/blog/posts/2014-02-04-how-i-develop-with-nixos.html">there</a> to learn the basics of nix and unix. We&rsquo;ll instead walk through the nix system to understand the fundamentals.</p>
<p>First thing to note: those stuff in nix store refer to software in nix store itself. It doesn&rsquo;t use libc from our system or whatelse. It&rsquo;s a self-contained nix bootstrap.</p>
<p>Quick note: in a normal installation, the store is owned by root and multiple users can install and build software through a nix daemon.</p>
<h3 id="so-small-nix-store"><strong>So small nix store</strong></h3>
<p>Start inspecting the output of the install command:</p>
<pre tabindex="0"><code>copying Nix to /nix/store..........................
</code></pre><p>Effectively, that&rsquo;s right the /nix/store we were talking in the first pill. The contents is the strictly necessary software to bootstrap a Nix system. You can see bash, core utils, the toolchain, perl libraries, sqlite and nix itself with its own tools and libnix.<br>
You surely noticed that in /nix/store not only directories are allowed, but also files, always in the form <em>hash</em>-<em>name</em>.</p>
<h3 id="the-holy-database"><strong>The holy database</strong></h3>
<p>Right after copying the store, the installation process initializes the database with the current information:</p>
<pre tabindex="0"><code>initialising Nix database...
</code></pre><p>Oh Nix also has a database. It&rsquo;s under /nix/var/nix/db. It is an sqlite database that keeps track of the dependencies between derivations.<br>
The schema is very simple: there&rsquo;s a table of valid paths, mapping from auto increment integer to store path.<br>
Then there&rsquo;s a dependency relation from one path to other paths.<br>
Inspect it running /nix/store/*sqlite*/bin/sqlite3 /nix/var/nix/db/db.sqlite</p>
<p><strong>Important rule</strong>: never change /nix/store manually because that wouldn&rsquo;t be in sync with the sqlite db, unless you know what you are doing.</p>
<h3 id="the-first-profile"><strong>The first profile</strong></h3>
<p>Then we discover the <a href="http://nixos.org/nix/manual/#sec-profiles">profile</a> concept during the installation:</p>
<pre tabindex="0"><code>creating /home/nix/.nix-profile
installing \`nix-1.7&#39;
building path(s) \`/nix/store/xxhdgml3rshn8mkaqxb86gp4r276sp9d-**user-environment**&#39;
created 6 symlinks in user environment
</code></pre><p>A profile in nix is a general and very convenient concept for realizing rollbacks. Profiles are used to compose more components that are spread among multiple paths, under a new unified path. Not only, profiles are made up of multiple generations: they are versioned. Whenever you change a profile, a new generation is created.<br>
Generations thus can be switched and rollback-ed atomatically.</p>
<p>Let&rsquo;s take a closer look at our profile:</p>
<pre tabindex="0"><code>$ ls -l ~/.nix-profile/
bin -&gt; /nix/store/clnpynyac3hx3a6z5lsy893p7b4rwnyf-**nix-1.7**/bin
\[...\]
manifest.nix -&gt; /nix/store/82dg18wz250vvcxjbclgyy5yg2kfz1gw-**env-manifest.nix**
\[...\]
share -&gt; /nix/store/clnpynyac3hx3a6z5lsy893p7b4rwnyf-**nix-1.7**/share
</code></pre><p>That nix-1.7 derivation in the nix store is nix itself, with binaries and libraries. The installation basically reproduced the hierarchy of the nix-1.7 derivation in the profile by means of symbolic links.<br>
The contents of this profile are special, because only one program has been installed in our profile, therefore e.g. the bin directory fully points to the only program being installed.</p>
<p>But that&rsquo;s only the contents of the latest generation of our profile. In fact, ~/.nix-profile itself is a symbolic link to /nix/var/nix/profiles/default .<br>
In turn, that&rsquo;s a symlink to default-1-link in the same directory. Yes, that means it&rsquo;s the generation #1 of the default profile.<br>
Finally that&rsquo;s a symlink to the nix store &ldquo;user-environment&rdquo; derivation that you saw printed during the installation process.</p>
<p>The manifest.nix will be meat for the next pill.</p>
<h3 id="meet-nixpkgs-expressions"><strong>Meet nixpkgs expressions</strong></h3>
<p>More wild output from the installer:</p>
<pre tabindex="0"><code>downloading Nix expressions from \`http://releases.nixos.org/nixpkgs/nixpkgs-14.10pre46060.a1a2851/nixexprs.tar.xz&#39;...
unpacking channels...
created 2 symlinks in user environment
modifying /home/nix/.profile...
</code></pre><p><a href="http://nixos.org/nix/manual/#chap-writing-nix-expressions">Nix expressions</a> are used to describe packages and how to build them. <a href="http://nixos.org/nixpkgs/">Nixpkgs</a> is the repository containing all these expressions: <a href="https://github.com/NixOS/nixpkgs">https://github.com/NixOS/nixpkgs</a> .<br>
The installer downloaded the package descriptions from commit a1a2851.</p>
<p>The second profile we meet is the channels profile. ~/.nix-defexpr/channels points to /nix/var/nix/profiles/per-user/nix/channels which points to channels-1-link which points to a nix store directory containing the downloaded nix expressions.</p>
<p>Channels are a set of packages and expressions available for download. Similar to debian stable and unstable, there&rsquo;s a stable and unstable channel. In this installation, we&rsquo;re tracking <a href="http://releases.nixos.org/nixpkgs/nixpkgs-14.10pre46060.a1a2851/">nixpkgs unstable</a>.</p>
<p>Don&rsquo;t bother yet with nix expressions.</p>
<p>Finally, for your own convenience, it modified ~/.profile to automatically enter the nix environment. What ~/.nix-profile/etc/profile.d/nix.sh really does is simply adding ~/.nix-profile/bin to PATH and ~/.nix-defexpr/channels/nixpkgs to NIX_PATH. We&rsquo;ll discuss about NIX_PATH in another pill.<br>
Read nix.sh, it&rsquo;s short.</p>
<h3 id="faq-can-i-change-nix-to-something-else">FAQ: Can I change /nix to something else?</h3>
<p>You can, but there&rsquo;s a strong reason to keep using /nix instead of a different directory. All the derivations depend on other derivations by absolute path. I remind you in <a href="http://lethalman.blogspot.it/2014/07/nix-pill-1-why-you-should-give-it-try.html">pill 1</a> that bash pointed to a glibc under /nix/store.<br>
You can see now by yourself, don&rsquo;t worry if you see multiple bash derivations:</p>
<pre tabindex="0"><code>$ ldd /nix/store/\*bash\*/bin/bash
\[...\]
</code></pre><p>Keeping the store in /nix means we can grab the binary cache from nixos.org (just like you grab packages from debian mirrors) otherwise:</p>
<ol>
<li>glibc would be installed under /foo/store</li>
<li>thus bash needs to point to glibc under /foo/store</li>
<li>the binary cache won&rsquo;t help, and we&rsquo;d have to recompile all the stuff by ourselves</li>
</ol>
<p>After all /nix is a cool place.</p>
<h3 id="conclusion">Conclusion</h3>
<p>We&rsquo;ve installed nix on our system, fully isolated and owned by the &ldquo;nix&rdquo; user as we&rsquo;re still diffident with this new system.</p>
<p>We learned some new concepts like profiles and channels. In particular, with profiles we&rsquo;re able to manage multiple generations of a composition of packages, while with channels we&rsquo;re able to download binaries from nixos.org .</p>
<p>The installation put everything under /nix, and some symlinks in the nix user home. That&rsquo;s because every user is able to install and use software in her own environment.</p>
<p>I hope I left nothing uncovered in a way that you think there&rsquo;s some kind of magic behind. It&rsquo;s all about putting components in the store and symlinking these components together.</p>
<p>Also I hope the commands in this pill were consistent with your fresh nix installation.</p>
<h3 id="next-pill">Next pill&hellip; </h3>
<p>&hellip;we will enter the nix environment and learn how to interact with the store.<br>
Pill 3 is available for <a href="http://lethalman.blogspot.it/2014/07/nix-pill-3-enter-environment.html">reading here</a>.</p>
<p>To be notified about the new pill, stay tuned on <a href="https://twitter.com/search?src=typd&amp;q=%23NixPills">#NixPills</a>, follow <a href="https://twitter.com/lethalman">@lethalman</a> or subscribe to the <a href="http://lethalman.blogspot.com/feeds/posts/default/-/nixpills">nixpills rss</a>.</p>
<ul class="pa0">
  
   <li class="list di">
     <a href="/tags/nixpkgs/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Nixpkgs</a>
   </li>
  
   <li class="list di">
     <a href="/tags/nix/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Nix</a>
   </li>
  
   <li class="list di">
     <a href="/tags/nixpills/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Nixpills</a>
   </li>
  
   <li class="list di">
     <a href="/tags/nixos/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Nixos</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/2014/07/nix-pill-1-why-you-should-give-it-try.html">Nix pill 1: why you should give it a try</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/2014/07/debugging-and-fixing-wmctrl-bug-in-nixos.html">Debugging and fixing a wmctrl bug in NixOS</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://lucabrun.github.io/" >
    &copy;  Luca Bruno blog 2024 
  </a>
    <div>
<div class="ananke-socials">
  
</div>
</div>
  </div>
</footer>

  </body>
</html>
